# nb × Claude Code カスタムコマンド設計

## 概要

nbのタスク・日報管理とClaude Codeを連携させるカスタムスラッシュコマンド。

---

## 1. `/task-from-daily`

### フロントマター

```yaml
---
description: 日報からタスク候補を抽出してnbに登録
argument-hint: "[日数] 過去N日分（デフォルト: 7）"
allowed-tools: Read, Bash, AskUserQuestion
---
```

### 目的

日報のメモ・サマリーからタスク候補を抽出し、未登録のものをnbタスクとして登録する。

### 日報パス

```
~/.nb/daily/YYYY-MM-DD.md
```

### 基本フロー

1. 指定期間の日報を読み込む（デフォルト: 過去7日）
2. 💡メモ + 📝サマリーからタスク候補を抽出
3. 既存の未完了タスクとゆるく照合（キーワードベース）
4. 未タスク化のものを提案
5. 承認されたものを `nb tasks:add` でタスク登録

### タスク登録形式

承認されたタスクは以下の形式で登録:

```bash
nb tasks:add --content "# [ ] タスク名

## Tags

#inbox

## Description

（日報からの抽出元を記載）
" --filename "$(date +%Y%m%d%H%M%S).todo.md"
```

- デフォルトタグ: `#inbox`（後で整理する前提）
- 優先度: 未設定（後で設定する前提）
- Description: 抽出元の日報日付・セクションを記載

### 抽出対象

| セクション | 抽出ルール |
|------------|-----------|
| 💡 メモ | 行動意図を含む内容のみ（下記判定基準参照） |
| 📝 サマリー | 「〜したい」「〜する」「TODO」等のパターンを抽出 |

### タスク性の判定基準

LLMが以下の観点でタスク候補かどうかを判定：

**タスクとして扱う:**
- 「〜する」「〜したい」「〜が必要」等の行動意図
- 具体的なアクション（「修正」「追加」「確認」「調査」等）
- 未完了を示唆する表現（「まだ」「残り」「TODO」等）

**タスクとして扱わない:**
- 感想・所感（「〜だった」「〜と思った」）
- 学び・気づき（「〜がわかった」「〜を学んだ」）
- 単なる事実の記録（「〜した」「〜を実施」）

### 類似判定

LLMによる意味的な類似判定を行う：
- メモ内容と既存タスク一覧を比較
- 同じ作業を指していると判断されたものは類似としてスキップ
- ルールベースではなく文脈を考慮した柔軟な判定

### 入力例

```bash
/task-from-daily          # 過去7日分
/task-from-daily 3        # 過去3日分
```

### 出力イメージ

```
## 日報から検出 (5件中 3件が未タスク化)

1. 「Notion,obsidianのメモを移行」
   📍 2025-12-19 サマリー
   → タスク化する？ [Y/n]

2. 「おしゃれなホーム画面を作る」
   📍 2025-12-18 メモ
   → タスク化する？ [Y/n]

3. 「PILOTに取り組む」
   📍 2025-12-19 サマリー
   → スキップ: 既存タスク「PILOT pdfファイルの参照先変更」と類似
```

---

## 2. `/daily-summary`

### フロントマター

```yaml
---
description: 最新の日報のサマリーを自動生成・更新
argument-hint: なし
allowed-tools: Read, Bash, Edit, AskUserQuestion
---
```

### 目的

最新の日報のサマリーを充実させる。日報を作成した後、いつでも実行してサマリーを自動生成・更新できる。

### 想定ワークフロー

```
1. nbd で日報作成（未完了タスク自動表示）
2. 作業しながらメモを書く（💡 メモセクション）
3. /daily-summary でサマリーを自動生成（任意のタイミングで実行可能）
4. 翌日の nbd で前日サマリーが引用表示される
```

### 基本フロー

1. `~/.nb/daily/` から最新の日報を特定
2. 対象日のgitコミットログを取得
3. 対象日の完了タスクを取得
4. Work/Personalに分類
5. 「📝 今日のサマリー」セクションを生成
6. ユーザーに確認表示
7. 承認後、日報ファイルに書き込み

### 入力ソース

| ソース | 取得先 | 用途 |
|--------|--------|------|
| 最新の日報 | `~/.nb/daily/` 内で最新のファイル | 💡メモを取り込む |
| 既存サマリー | 日報内の「📝 今日のサマリー」セクション | 入力ソースとして統合 |
| 完了タスク | `## Completed` セクションの日付で検索 | サマリーに反映 |
| gitログ（Work） | `~/src/github.com/ebase-dev/*` 配下 | サマリーに反映 |
| gitログ（Personal） | `~/.dotfiles` | サマリーに反映 |

### 具体的なコマンド例

**最新日報の特定:**
```bash
ls -1 ~/.nb/daily/*.md | grep -E '[0-9]{4}-[0-9]{2}-[0-9]{2}\.md$' | sort | tail -1
```

**対象日の完了タスク取得:**
```bash
# 日報の日付（例: 2025-12-22）に完了したタスクを検索
# 注: Completedセクションは「## Completed\n\n日付」の形式（空行あり）
for f in ~/.nb/tasks/*.md; do
  completed=$(awk '/^## Completed/{getline; getline; print}' "$f" 2>/dev/null)
  if [[ "$completed" == "2025-12-22" ]]; then
    awk '/^# \[x\]/{gsub(/^# \[x\] */, ""); print}' "$f"
  fi
done
```

**gitログ取得（Work）:**
```bash
# 対象日のコミットを取得
for repo in ~/src/github.com/ebase-dev/*/; do
  git -C "$repo" log --oneline --since="2025-12-22 00:00" --until="2025-12-23 00:00" --author="$(git config user.email)" 2>/dev/null
done
```

**gitログ取得（Personal）:**
```bash
git -C ~/.dotfiles log --oneline --since="2025-12-22 00:00" --until="2025-12-23 00:00" --author="$(git config user.email)" 2>/dev/null
```

### 分類ルール

| 条件 | 分類 |
|------|------|
| タスクの `## Tags` セクションに `#work` タグあり | Work |
| `~/src/github.com/ebase-dev/*` のコミット | Work |
| その他すべて | Personal |

### 入力例

```bash
/daily-summary            # 最新の日報のサマリーを更新
```

### 出力イメージ

```markdown
## 📝 今日のサマリー

### Work
- ChatComposerのスクロールバーUI修正 (3 commits)
- PRレビュー対応
- ○○タスク完了

### Personal
- nb関数の最適化
- dotfiles整備
```

### サマリー生成ロジック

すべての入力ソース（既存サマリー、gitログ、メモ）をLLMに渡し、統合した新しいサマリーを生成：

- 既存サマリーの内容は失わない（入力として考慮）
- 重複する内容は統合
- Work/Personalに再分類

---

## エラーハンドリング

### `/task-from-daily`

| 状況 | 対応 |
|------|------|
| 対象期間の日報が0件 | 「対象期間に日報が見つかりません」と表示して終了 |
| タスク候補が0件 | 「タスク候補が見つかりませんでした」と表示して終了 |
| すべて既存タスクと類似 | 「新規タスク候補はありませんでした」と表示して終了 |

### `/daily-summary`

| 状況 | 対応 |
|------|------|
| 日報が0件 | 「日報が見つかりません。nbdで作成してください」と表示して終了 |
| gitリポジトリなし | スキップして他のソースで生成 |
| 入力ソースがすべて空 | 「サマリーを生成する情報がありません」と表示して終了 |

---

## 参考

- 既存コマンド: `~/.claude/commands/weekly-report.md`
- nb設定: `~/.config/nb/functions.zsh`
- 日報テンプレート: `~/.nb/daily/.templates/daily.md`
