---
description: リモート変更を取り込んでmainブランチに安全に切り替え
argument-hint: なし
allowed-tools: Read, Bash, AskUserQuestion
---

## 作業指示

**深く思考してください**: このコマンドはリモートリポジトリの変更を安全に取り込み、ローカルの変更を適切に処理してmainブランチに切り替える重要な操作です。データ損失を防ぎ、ユーザーの意図を正確に把握する必要があります。

**遠慮せずに、全力を尽くしてください**: git操作の安全性を最優先し、各ステップで状態を確認し、ユーザーに明確な選択肢を提供してください。

## 実行制限

**以下の作業のみを実行し、これ以外は絶対に行わない：**
- ユーザーへの質問（AskUserQuestion）
- git状態の確認（git status, git fetch等）
- ローカル変更の処理（stash, commit）
- ブランチの切り替えとマージ

**禁止事項：**
- ユーザーの確認なしでのコミット作成
- ユーザーの確認なしでのブランチ削除
- 強制的なgit操作（--force等）
- 不要なファイルの作成・編集・削除

## 実行フロー

### ステップ1: 現在の状態確認

```bash
# 現在のブランチとローカル変更を確認
git status
git fetch origin
```

ローカル変更の有無をチェック。

### ステップ2: ローカル変更がある場合の処理選択

**ローカルに未コミットの変更がある場合のみ、AskUserQuestionツールで質問**:

- 質問: "ローカルに未コミットの変更があります。どのように処理しますか？"
- 選択肢:
  1. **stash（一時退避）** - 変更を一時的に退避して後で復元可能にする
  2. **commit（コミット）** - 現在の変更をコミットしてから切り替える
  3. **cancel（キャンセル）** - 操作を中止する

### ステップ3: 選択に応じた処理

#### stashが選択された場合:
```bash
git stash push -m "sync-main: auto-stash before switching to main"
```

#### commitが選択された場合:
- コミットメッセージを生成して表示
- 確認後にコミット実行
```bash
git add .
git commit -m "[生成されたメッセージ]"
```

#### cancelが選択された場合:
- 処理を中止し、現在のブランチに留まる

### ステップ4: mainブランチに切り替え

```bash
git checkout main
# または
git switch main
```

### ステップ5: リモートの変更をマージ

```bash
git pull origin main
# または
git merge origin/main
```

### ステップ6: 完了確認

切り替えとマージが成功したことを確認し、結果を表示。

---

## 出力形式

### 成功時（変更なしの場合）

```markdown
✅ mainブランチへの切り替え完了

**現在のブランチ**: main
**リモート変更**: 最新の状態です
**ローカル変更**: なし
```

### 成功時（stash使用）

```markdown
✅ mainブランチへの切り替え完了

**現在のブランチ**: main
**リモート変更**: マージ完了（X件のコミット）
**ローカル変更**: stashに退避済み

stashした変更を復元するには:
\`\`\`bash
git stash pop
\`\`\`
```

### 成功時（commit使用）

```markdown
✅ mainブランチへの切り替え完了

**現在のブランチ**: main
**リモート変更**: マージ完了（X件のコミット）
**コミット**: 作成済み（[コミットハッシュ]）
```

### キャンセル時

```markdown
ℹ️ 操作をキャンセルしました

現在のブランチに留まります。
```

---

## エラー処理

### コンフリクト発生時
```markdown
⚠️ マージコンフリクトが発生しました

以下のファイルでコンフリクトが発生しています:
- [ファイル1]
- [ファイル2]

コンフリクトを解決してから、以下のコマンドを実行してください:
\`\`\`bash
git add .
git commit
\`\`\`
```

### ブランチが存在しない
```markdown
❌ mainブランチが見つかりません

リポジトリを確認してください。
```

---

## 使用例

```bash
# コマンド実行
/github:workflow:sync-main

# 現在の状態確認...
# ローカル変更検出

# → 質問: "ローカルに未コミットの変更があります。どのように処理しますか？"
# ○ stash（一時退避）（選択）
# ○ commit（コミット）
# ○ cancel（キャンセル）

# stash実行...
# mainブランチに切り替え...
# リモート変更をマージ...

# ✅ mainブランチへの切り替え完了
```

---

## 重要な制約

- **安全性優先**: データ損失を防ぐため、すべての変更を適切に処理
- **ユーザー選択**: 重要な操作は必ずユーザーの選択を求める
- **明確な出力**: 何が行われたかを明確に表示

これ以外は実行しない。
